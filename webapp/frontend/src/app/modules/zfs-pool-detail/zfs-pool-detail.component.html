<div class="zfs-pool-detail flex flex-col flex-auto w-full p-8 xs:p-2">

    <div class="flex flex-wrap w-full">

        <!-- Header Section -->
        <div class="flex items-center justify-between w-full my-4 px-4 xs:pr-0">
            <div class="flex items-center mr-6">
                <button mat-icon-button (click)="goBack()" class="mr-4">
                    <mat-icon [svgIcon]="'arrow_back'"></mat-icon>
                </button>
                <div>
                    <h2 class="m-0">ZFS Pool Details - {{ pool?.name }}</h2>
                    <div class="text-secondary tracking-tight">Storage pool configuration and status</div>
                </div>
            </div>
            <!-- Action buttons -->
            <div class="flex items-center">
                <button class="xs:hidden"
                        matTooltip="not yet implemented"
                        mat-stroked-button>
                    <mat-icon class="icon-size-20"
                              [svgIcon]="'save'"></mat-icon>
                    <span class="ml-2">Export</span>
                </button>
                <button class="ml-2 xs:hidden"
                        matTooltip="not yet implemented"
                        mat-stroked-button>
                    <mat-icon class="icon-size-20 rotate-90 mirror"
                              [svgIcon]="'tune'"></mat-icon>
                    <span class="ml-2">Settings</span>
                </button>

                <!-- Actions menu (visible on xs) -->
                <div class="hidden xs:flex">
                    <button [matMenuTriggerFor]="actionsMenu"
                            mat-icon-button>
                        <mat-icon [svgIcon]="'more_vert'"></mat-icon>
                    </button>
                    <mat-menu #actionsMenu="matMenu">
                        <button mat-menu-item
                                matTooltip="not yet implemented">
                            <mat-icon class="icon-size-20"
                                      [svgIcon]="'save'"></mat-icon>
                            <span class="ml-2">Export</span>
                        </button>
                        <button mat-menu-item
                                matTooltip="not yet implemented">
                            <mat-icon class="icon-size-20 rotate-90 mirror"
                                      [svgIcon]="'tune'"></mat-icon>
                            <span class="ml-2">Settings</span>
                        </button>
                    </mat-menu>
                </div>
            </div>
        </div>

        <!-- Left Stats Panel -->
        <div class="flex flex-auto w-1/4 p-4 lt-md:w-full">
            <treo-card class="flex flex-auto p-4 flex-col filter-list">
                <div class="flex flex-col space-y-6">
                    
                    <!-- Pool Status -->
                    <div class="my-2">
                        <div class="flex items-start mb-2">
                            <mat-icon class="icon-size-24 mr-3 mt-1" 
                                      [ngClass]="zfsService.getPoolStatusClass(pool?.state)"
                                      [svgIcon]="zfsService.getPoolStatusIcon(pool?.state)"></mat-icon>
                            <span class="inline-flex items-center font-bold text-xs px-2 py-1 rounded-full tracking-wide uppercase"
                                  [ngClass]="getStateBackgroundClass(pool?.state)">
                                <span class="w-2 h-2 rounded-full mr-2"
                                      [ngClass]="{'bg-red': pool?.state !== 'ONLINE', 'bg-green': pool?.state === 'ONLINE'}"></span>
                                <span class="leading-relaxed whitespace-nowrap">{{ pool?.state }}</span>
                            </span>
                        </div>
                        <div class="text-secondary text-md">Pool Status</div>
                    </div>

                    <!-- Data Age -->
                    <div class="my-2">
                        <div class="flex items-center mb-2">
                            <mat-icon class="icon-size-20 mr-3" 
                                      [class.text-red-600]="isDataStale()"
                                      [class.text-green-600]="!isDataStale()"
                                      [svgIcon]="isDataStale() ? 'heroicons_outline:exclamation-triangle' : 'heroicons_outline:clock'"></mat-icon>
                            <span class="text-sm font-medium" [ngClass]="getDataAgeColorClass()">
                                Last Updated on {{ pool?.updated_at | date:'MMMM dd, yyyy - HH:mm' }}
                            </span>
                        </div>
                        <div class="text-secondary text-md">Last Updated</div>
                    </div>

                    <!-- Scan Information -->
                    <div class="my-2" *ngIf="pool?.scan_function && pool?.scan_state">
                        <div>{{ formatScanInfo() }}</div>
                        <div class="text-secondary text-md">Last Scan</div>
                    </div>

                    <!-- Status Messages -->
                    <div class="my-2" *ngIf="pool?.status && pool?.status.trim()">
                        <div class="text-sm bg-gray-100 dark:bg-gray-700 p-2 rounded">{{ pool?.status.trim() }}</div>
                        <div class="text-secondary text-md mt-1">Status Message</div>
                    </div>

                    <div class="my-2" *ngIf="pool?.action && pool?.action.trim()">
                        <div class="text-sm text-orange-600 dark:text-orange-300 bg-orange-50 dark:bg-orange-900 p-2 rounded border border-orange-200 dark:border-orange-700">
                            {{ pool?.action.trim() }}
                        </div>
                        <div class="text-secondary text-md mt-1">Required Action</div>
                    </div>

                    <!-- Capacity Information -->
                    <div class="my-2">
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-bold">{{ getCapacityPercentage() }}%</span>
                                <span class="text-sm text-gray-500 dark:text-gray-400">used</span>
                            </div>
                            <div class="capacity-bar-modern">
                                <div class="capacity-fill-modern"
                                     [ngClass]="getCapacityColorClass()"
                                     [style.width.%]="getCapacityPercentage()"></div>
                            </div>
                        </div>
                        <div class="text-secondary text-md mt-2">Storage Utilization</div>
                    </div>

                    <!-- Space Breakdown -->
                    <div class="my-2">
                        <div>{{ zfsService.formatBytes(pool?.alloc_space) }}</div>
                        <div class="text-secondary text-md">Space Used</div>
                    </div>

                    <div class="my-2">
                        <div>{{ zfsService.formatBytes(pool?.def_space) }}</div>
                        <div class="text-secondary text-md">Space Available</div>
                    </div>

                    <div class="my-2">
                        <div>{{ zfsService.formatBytes(pool?.total_space) }}</div>
                        <div class="text-secondary text-md">Total Space</div>
                    </div>

                    <!-- Error Statistics -->
                    <div class="my-2">
                        <div class="font-medium" [class.text-red-600]="pool?.read_errors !== '0'">
                            {{ pool?.read_errors || '0' }}
                        </div>
                        <div class="text-secondary text-md">Read Errors</div>
                    </div>

                    <div class="my-2">
                        <div class="font-medium" [class.text-red-600]="pool?.write_errors !== '0'">
                            {{ pool?.write_errors || '0' }}
                        </div>
                        <div class="text-secondary text-md">Write Errors</div>
                    </div>

                    <div class="my-2">
                        <div class="font-medium" [class.text-red-600]="pool?.checksum_errors !== '0'">
                            {{ pool?.checksum_errors || '0' }}
                        </div>
                        <div class="text-secondary text-md">Checksum Errors</div>
                    </div>


                </div>
            </treo-card>
        </div>

        <!-- Right Structure Panel -->
        <div class="flex flex-auto w-3/4 p-4 lt-md:w-full">
            <treo-card class="flex flex-auto p-4 flex-col">
                <div class="text-xl font-semibold mb-4">Virtual Device Configuration</div>
                <div class="text-secondary text-sm mb-6">Storage device hierarchy and detailed status information</div>
                
                <div class="vdev-tree-container">
                    <!-- Tree Header -->
                    <div class="tree-header grid grid-cols-10 gap-4 py-3 px-4 border-b bg-gray-50 dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300">
                        <div class="col-span-5">Device</div>
                        <div class="col-span-1 text-center">State</div>
                        <div class="col-span-1 text-center">Read</div>
                        <div class="col-span-1 text-center">Write</div>
                        <div class="col-span-1 text-center">Cksum</div>
                        <div class="col-span-1 text-center">Capacity</div>
                    </div>


                    <!-- Virtual Device Tree -->
                    <div *ngFor="let vdev of getVdevTree(); let i = index" 
                         class="tree-row grid grid-cols-10 gap-4 py-3 px-4 border-b hover:bg-gray-50 dark:hover:bg-gray-700"
                         [class.bg-blue-25]="vdev.indent === 1">
                        <div class="col-span-5 flex items-center" [style.padding-left.rem]="(vdev.indent - 1) * 2">
                            <!-- Indent lines -->
                            <div class="flex items-center mr-3" *ngIf="vdev.indent > 1">
                                <div *ngFor="let line of getIndentLines(vdev.indent - 1)" 
                                     class="w-4 h-4 flex items-center justify-center">
                                    <div *ngIf="line === 'line'" class="w-px h-full bg-gray-300 dark:bg-gray-600"></div>
                                    <div *ngIf="line === 'corner'" class="w-2 h-2 border-l border-b border-gray-300 dark:border-gray-600"></div>
                                    <div *ngIf="line === 'tee'" class="w-2 h-4 border-l border-b border-gray-300 dark:border-gray-600"></div>
                                </div>
                            </div>
                            
                            <!-- Device Icon -->
                            <mat-icon class="icon-size-18 mr-2" 
                                      [class.text-orange-600]="vdev.vdev_type.includes('raidz')"
                                      [class.text-purple-600]="vdev.vdev_type === 'mirror'"
                                      [class.text-gray-600]="vdev.vdev_type === 'disk'"
                                      [svgIcon]="getVdevIcon(vdev.vdev_type)"></mat-icon>
                            
                            <!-- Device Info -->
                            <div class="min-w-0 flex-1">
                                <div class="font-medium text-sm text-gray-900 dark:text-gray-100 truncate" 
                                     [title]="vdev.displayName">{{ vdev.displayName }}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400" *ngIf="vdev.path && vdev.name !== vdev.path"
                                     [title]="vdev.name">{{ vdev.name }}</div>
                            </div>
                        </div>
                        
                        <div class="col-span-1 text-center">
                            <span class="inline-block px-2 py-1 rounded text-xs font-medium"
                                  [ngClass]="getStateBackgroundClass(vdev.state)">
                                {{ vdev.state }}
                            </span>
                        </div>
                        
                        <div class="col-span-1 text-center font-mono text-sm"
                             [class.text-red-600]="vdev.read_errors !== '0'">
                            {{ vdev.read_errors || '0' }}
                        </div>
                        
                        <div class="col-span-1 text-center font-mono text-sm"
                             [class.text-red-600]="vdev.write_errors !== '0'">
                            {{ vdev.write_errors || '0' }}
                        </div>
                        
                        <div class="col-span-1 text-center font-mono text-sm"
                             [class.text-red-600]="vdev.checksum_errors !== '0'">
                            {{ vdev.checksum_errors || '0' }}
                        </div>
                        
                        <div class="col-span-1 text-center text-sm">
                            <span *ngIf="vdev.total_space && vdev.alloc_space; else noCapacity">
                                {{ getVdevCapacityPercentage(vdev) }}%
                            </span>
                            <ng-template #noCapacity>-</ng-template>
                        </div>
                    </div>
                </div>
            </treo-card>
        </div>

    </div>
</div>
